---
title: ""
output: pdf_document
header-includes:
   - \usepackage{lineno}
   - \linenumbers
   - \usepackage{setspace}
   - \doublespacing
csl: apa.csl
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE,
                      message = FALSE)

library(hatchR)
library(tidyverse)
library(patchwork)
library(ggridges)
library(modelbased)
```

# A generalizable tool for predicting developmental phenology for wild poikilotherms.

Morgan M. Sparks^1^, Brian Z. Leavell^2^, Bryan M. Maitland^1^

^1^Rocky Mountain Research Station, U.S. Forest Service, Boise, Idaho

^2^ Brian's deets here

\newpage

# Abstract

Before exogenous feeding, poikilothermic organisms have a near mechanistic relationship between ambient temperature and developmental rates. As such, statistical models can be easily developed to predict when organisms develop. Until recently, most models only used non-variable developmental regimes making them difficult to apply to wild environments. However, the R package hatchR formalized an approach using effective values where each day is given a developmental unit, accurately predicting developmental phenology for wild poikilotherms. hatchR was developed specific to fish, however this manuscript broadens the tool's application showing how it can be used to predict developmental phenology for a broad range of taxa, including amphibians, reptiles, and invertebrates. Moreover, we provide numerous examples of how this approach informs scenarios from applied management to basic questions regarding ecological and evolutionary questions.

\newpage

# Introduction

P1: Poikilotherms and ambient temperatures

P2: ATU models and effective value models

P3: Examples with other species

P4: Our approach here (R package and Shiny app)

# Methods

## Effective value models

Effective value models function by leveraging the statistical relationship derived from raising poikilotherms at different temperatures and fitting that relationship with a non-linear model. The formulation of that relationship can then be reciprocated which provides the unit of development for a day's average temperature--an effective value. Effective value models function then by cumulatively summing to one at which the organism achieves the development of the parameterized trait.

The model follows the general format of:

$$
Effective Value_i = 1/exp(log_ea - log_e(Temperature_i - b))
$$

Where *i* is the daily value and a fish hatches or emerges when the cumulative sum reaches one: $$\sum_{i =1}^nEffectiveValue_i = 1$$

As an example, we parameterize an effective value model for coastal tailed frogs (*Ascaphus truei*) common to western North America (Figure 1). Custom parameterized models use the `fit_model()` function in hatchR, which is built on model 2 using the power law from @beacham1990. Alternatively, to predict phenology using hatchR, the `predict_phenology()` only requires a model expression as input and could assume other model formulations custom built outside of the package by the user.

```{r, fig.align = 'center', fig.cap="Custom hatching phenology model for coastal tailed frogs (Ascaphus truei).Panel A represents the model fit and raw data used to generate the effective value model and panel B are the effective values for daily temperatures between 6 and 20 °C. A dashed line with a 0.01 increase for every degree increase in included for reference."}
# Brown 1975, Comparitive Biochemistry and Physicology Part A: Physiology
# https://www.sciencedirect.com/science/article/pii/030096297590033X

### parameterize mod
ascaphus_data <- tibble(temp = c(7.6,9.8,11,13,14.5,15,18),
                        days = c(44,27.1,22.6,16.1,13.4,12.7,10.7))

ascaphus_mod <- fit_model(temp = ascaphus_data$temp,
                          days = ascaphus_data$days,
                          species = "ascaphus",
                          development_type = "hatch")

### get effective values
temps <- c(6:20)

ef_vals <- NULL
for (x in temps) {
  ef <- eval(parse(text = ascaphus_mod$expression$expression))
  ef_vals <- rbind(ef_vals, ef)
}

ascaphus_ef <- matrix(NA, 15, 2) |> tibble::tibble()
colnames(ascaphus_ef) <- c("temp", "ef")
ascaphus_ef$temp <- temps
ascaphus_ef$ef <- ef_vals[, 1]


### plot

fmt <- "~R^2 ==  %.4f"
lab1 <- sprintf(fmt, ascaphus_mod$r_squared)
p1 <- ascaphus_mod$pred_plot +
  labs(x = "Incubation Temperature (°C)", y = "Days to Hatch") +
  lims(y = c(0, 50)) +
  annotate("text", x = 10, y = c(35), label = c(lab1),  hjust = 0, parse = TRUE)

data_1 <- tibble(t = c(0:20), e = seq(0, 0.20, by = 0.01))

p2 <- ascaphus_ef |>
  ggplot() +
  geom_point(aes(x = temp, y = ef)) +
  geom_line(aes(x = temp, y = ef)) +
  geom_line(data = data_1, aes(x = t, y = e), linetype = "dashed") +
  # geom_abline(intercept = 0, slope = .01, linetype = "dashed") +
  labs(x = "Daily Average Temperature (°C)", y = "Effective Value") +
  theme_classic()

p1 + p2 + plot_annotation(tag_levels = 'A')
```

## Data and data checks

hatchR requires two essential paired vectors of data, one of daily average temperature and the other the date for those temperatures. The software is designed to function around common field temperature loggers and provides users the ability to summarize temperatures with multiple daily recordings.

### Data input

Maybe include the below:

```{r}
df <- data.frame(
  date = c(
    "2024-01-01",
    "...",
    "2024-07-01",
    "...",
    "2024-12-31"
  ),
  temperature = c(
   4.67,
    "...",
    22.31,
    "...",
    2.58
  )
)

knitr::kable(df,
  booktabs = TRUE,
  caption = "Example temperature data for use in hatchR."
)
```

If you import data from raw files with multiple daily readings, the package allows you to summarize your with `summarize_temp()` and then check summarized data with the `plot_check_temp()` and `check_continuous()` functions.

## Predicting phenology

hatchR has two function to predict phenology. The first is `predict_phenology()` where users input date of reproductive event (`spawn.date`) along with their daily average temperature and corresponding dates. Alternatively, the function `predict_spawn()` leverages the effective value model framework but works backward from observed or expected development. For example, if a user observed one of the many frog or reptile parameterizations below in an area where they had accurate temperature measurements, they could easily estimate when those individuals' adults mated.

# Case studies

There are numerous applications for effective value models and poikilotherms that expand well beyond the bounds of this manuscript. We provide examples spanning four taxonomic classes of pikilotherms in the table below of studies that could liekly be used to parameterize custom models using the `fit_model()` function from hatchR. These are a non-exhaustive search of the both peer-reviewed and grey literature, but demonstrate the wide taxonomic breadth that could be paired with the effective value approach. We provide case studies of how these data may be used to address a variety of questions, but expect applications to extend far beyond what we demonstrate here.

| Class | Order | Genera | Species | Study |
|:--------------|:--------------|:--------------|:--------------|:--------------|
| Amphibia | Anura | *Lithobates* | *L. sylvaticus* | @moore1939 |
|  |  |  | *L. pipiens* |  |
|  |  |  | *L. clamitans* |  |
|  |  |  | *L. palustris* |  |
|  |  | *Ascaphus* | *A. truei* | @brown1975 |
|  | Urodela | *Ambystoma* | *A. gracile* | @brown1976 |
| Reptilia | Squamata | *Sceloporus* | *S. undulatus* | @angilletta2000 |
|  |  | *Podarcis* | *P. mural*is | @vandamme1992 |
|  | Testudines | *Mauremys* | M. reevesii | @du2007 |
|  |  |  | 181 species | 141 studies in @while2018 |
| Insecta | Plecoptera | *Nemurella* | *N. pictetii* | @brittain1978, @elliott1984 |
|  |  | *Capnia* | *C. atra* | @brittain1984 |
|  |  | *Capnia* | *C. bifrons* | @elliott1986 |
|  |  | *Mesocapnia* | *M. oenone* | @brittain1984 |
|  |  | *Taeniopteryx* | *T. nebulosa* | @brittain1977 |
|  | Coleoptera | *Colaphellus* | *C. bowringi* | @tang2017 |
|  |  |  | 18 species | Developmental equations in @pritchard1987 |
| Malacostraca | Decapoda | *Pontastacus* | *P. leptodactylus* | @aydin2004 |

: Sources for effective value parameterizations using `fit_model()` in hatchR. Represented are a broad range of taxa and some review studies which include numerous putative sources. @while2018 and @pritchard1987 not vetted for full functionality and equations would need to be reciprocated.

```{r, eval=FALSE}

# trying to find study with multiple good pops (failing)


reptiles <- read_csv("../../data/reptile_database.csv")

unique(reptiles$trait)

#species count
reptiles |> 
  filter(trait == "Incubation duration") |> 
group_by(first_author_surname, pub_year, genus, species) |> 
  summarise(count = n()) 
  

#study count
reptiles |> 
  filter(trait == "Incubation duration") |> 
group_by(first_author_surname, pub_year) |> 
  summarise(count = n())

#species count
reptiles |> 
  filter(trait == "Incubation duration") |> 
group_by(first_author_surname, pub_year, genus, species, population) |> 
  slice_head() |> 
  group_by(genus, species, state_province) |>  
  summarise(count = n()) |> 
  arrange(desc(count))

# nost common species

reptiles |> 
  filter(trait == "Incubation duration") |> 
  filter( genus == "Caretta" & species == "caretta") |> 
  group_by(first_author_surname, pub_year, population ) |> 
  ggplot(aes(x = T, y = mean, color = first_author_surname, shape = population)) +
  geom_point() +
  geom_line() +
  theme_classic()

reptiles |> 
  filter(trait == "Incubation duration") |> 
  filter( genus == "Sceloporus" & species == "undulatus") |> 
  group_by(first_author_surname, pub_year, population ) |> 
  ggplot(aes(x = T, y = mean, color = first_author_surname, shape = population, group = population)) +
  geom_point() +
  geom_line() +
  theme_classic()
```

## Ecological

To demonstrate an ecological application for hatchR, we used estimates for oviposition timing for *A. truei* from @karraker2006 (unpublished data). Using the parameterized coastal tailed frog model presented above (Figure 1) and assumed a fixed oviposition date based on the estimates from @karraker2006 we predicted days to hatch for populations in Washington and Oregon, where long-term temporal predictions of stream temperature were available [@siegel2023] at the COMID level. Our results indicate developmental rates were highly variable over different physical habitats (streams originating in lowland hills compared with those originating in mountain ranges with permanent snow fields), with average days to hatch taking more than twice as long in Olympic National Park as in the Willapa Hills (32 days compared to 15 days). When broken down by site, there was a weak but significant relationship between year and days to hatch (Supplemental Data), with slight negative trend over the thirty year period, indicating temperatures at the sites were warming (Figure 2). Over the 30-year period, the site with the quickest average developmental period was in the Willapa Hills (15 days) and the site with the longest average developmental period was in Olympic National Park (44 days). Finally, the standard deviation at Willapa Hills, Siskiyou Mountains, and Cascade Mountains was much lower (\<3) than that of the Olympic National Park sites (11.0) indicating much less sensitivity to temperature change over the 30-years.

```{r, eval=FALSE}
ascaphus_sites <- readxl::read_xlsx("../../data/ascaphus_locations.xlsx") |> drop_na(comid)


#########################################
# ONLY RUN IF YOU DOWNLOAD SIEGEL FILES #
#########################################


# print huc_6 to download from https://zenodo.org/records/8174951

huc_6 <-ascaphus_sites |> 
  drop_na(comid) |> 
  pull(HUC_6) |> 
  unique()

ascaphus_siegel_data <- NULL

for( h in huc_6 ){
huc_6_files <- fs::dir_ls(paste0("../../data/siegel_data/st_pred_", h))

#filter to huc10 to subset files
huc_10 <- ascaphus_sites |> 
  filter(HUC_6 == h) |> 
  pull(HUC_10) |> 
  unique()

# get comids to filter mega df created below
comids <- ascaphus_sites |> 
  drop_na(comid) |> 
  filter(HUC_10 %in% huc_10) |> 
  pull(comid) |> 
  unique()

# change to single character for pattern in function below
huc_10_patterns <- ifelse(length(huc_10) >1, paste0(huc_10, collapse = "|"), paste0(huc_10))

# put files in a df together
huc_10_df <- huc_6_files |>
  str_subset(pattern = (huc_10_patterns)) |> # str subset on huc10
  map_df(read_csv, .id = "file", col_types = cols()) |> 
  filter(COMID %in% comids)

#append to single file
ascaphus_siegel_data <- rbind(ascaphus_siegel_data, huc_10_df)

}

write_rds( ascaphus_siegel_data, "../../data/ascaphus_siegel_data.rds", compress = "gz" )
```

\

```{r, fig.height= 6 , fig.width= 8, fig.align = 'center', fig.cap="Estimated marginal means of days to hatch for coastal tailed frogs from various mountain ranges across their range."}
ascaphus_siegel_data <- readRDS("../../data/ascaphus_siegel_data.rds") |> 
  mutate(date = ymd(tim.date))

ascaphus_sites <- readxl::read_xlsx("../../data/ascaphus_locations.xlsx") |> drop_na(comid)

#karraker_data <- readxl::read_xls("../../data/ASMO_ASTR_egg_data.xls")



pred_hatch = NULL
for(sites in unique(ascaphus_siegel_data$COMID)) {
  
  ascaphus_site <- ascaphus_sites |> filter(comid == sites)
  
  month <- month(ascaphus_site$oviposition_date)
  mday <- mday(ascaphus_site$oviposition_date)
  
  spawn_dates <- map(
  c(1991:2020), # year vector to map for custom function
  function(year) { # custom function to make dates
      paste0(year,"-", month, "-", mday)
    }
  ) |> 
  unlist()
  
  site <-  ascaphus_siegel_data |> filter( COMID == sites) |> drop_na(prd.stream_temp)
  
 # spawn_dates <- spawn_dates[which(spawn_dates %in% site$tim.date)]
  
  hatch <- map(spawn_dates, 
               predict_phenology,
              data = site,
              temperature = prd.stream_temp,
              dates = date,
              model = ascaphus_mod$expression$expression) |> 
    map_df("dev_period") |> 
    mutate(days = stop -start)
  
  temp_df <- data.frame(days = hatch$days,
                        comid = rep(sites, times =length(hatch)),
                        year = year(spawn_dates))
  
  pred_hatch <- rbind(pred_hatch, temp_df)
}

model_data <- pred_hatch |> 
  left_join(ascaphus_sites |> group_by(comid) |> slice_head( n =1), by = join_by(comid == comid)) |> 
  mutate(days = as.integer(days),
         comid = as.factor(comid))

# model_data |>
#   ggplot() +
#   geom_density_ridges(aes(y = as.factor(year), x = days , fill = Mountain)) +
#   theme_classic() +
#   theme(legend.position = "none")
# 
# model_data |>
#   ggplot(aes(x = year, y = days , color= Mountain, group = comid)) +
#   geom_point() +
#   #geom_line() +
#   geom_smooth(method = "lm", se = FALSE) +
#   labs(x= "Year", y = "Hatch Date") +
#   theme_classic() +
#   theme(legend.position = c(0.8, 0.75))

mod <- lm(days ~ year*as.factor(comid) + Mountain, data = model_data)

means <- estimate_means(mod, c("year", "comid")) |>  tibble()

means  |> 
  mutate(comid = as.integer(as.character(comid))) |> 
  left_join(ascaphus_sites, by = join_by(comid == comid)) |> 
  ggplot(aes(x = year,
             y = Mean,
                  ymin= CI_low, 
                  ymax = CI_high,
                  group = comid,
                  fill = Mountain,
             color = Mountain)) +
  geom_line(size = 1.1) +
  geom_ribbon(alpha = 0.05, color = NA) +
  labs(x = "Year", y = "Mean of Days to Hatch") +
  theme_classic()

# estimate_means(mod, c("year", "comid")) |> 
#   plot() +
#   #geom_point(data = pred_hatch, aes(x = year, y = days, color = Mountain), size = 0.5 , alpha = 0.25) +
#   labs(x = "Year", y = "Mean of Days to Hatch") +
#   theme_classic()
```

```{r, eval=FALSE}

model_data |> 
  drop_na(days) |>  
  group_by(Mountain) |> 
  summarise(mean_hatch = round(mean(days), 1),
            sd_hatch =sd(days))

model_data |> 
  drop_na(days) |>  
  group_by(Mountain, comid) |> 
  summarise(mean_hatch = round(mean(days), 1))

sjPlot::tab_model(mod)
```

## Phylogenetic

As species diverge from one another it is expected that phenotypes respond to different niche space which is part of that divergence. To assess those differences,one can execyte experiments that test phenotypic divergence (common garden or reciprocal transplant) and display phenotypic data as reaction norms, showing the relative genetic and environmental contribution to phenotypes. hatchR is a unique tool for demonstrating these differences because the strong fits of developmental rates, either displayed as model fits or the linearized effective value model lines are forms of reaction norms, even if species did not experience the same developmental conditions. While not as precise as using controlled experiments, hatchR derived reaction norms can be used to demonstrate how genetic x environment interactions vary among species and how those phenotypes may fit the niche spaces occupied by phylogenetically close or divergent species.

To demonstrate this approach, we leverage custom time to hatch parameterizations for four *Lithobates* frog species developed by @moore1939. We show large differences in developmental rates for common North American frogs which often overlap in their ranges—green frog, *L. clamitans*; northern leopard frog, *L. pipiens*; pickerel frog, *L. palustris*; and wood frog, *L. sylvaticus*. Specifically, when developmental models were fit to a randomly generated temperature regime of 16 and 24 C°, the species-specific effects of devlopment are clear. Whereas at warm temperatures, all species hatch the same day or within one day of one another, at cold temperatures, wood frogs develop the quickest and green frogs the slowest (twice the rate of wood frogs).

BRIAN ADD SOMETHING ABOUT THEIR ECOLOGY ABOVE TO FIT THIS INTO BROADER CONTEXT.

```{r, fig.height= 8 , fig.width= 8, fig.align = 'center', fig.cap="Custom hatch timing models developed for four North American frog species. Models are parameterized from Moore 1939 and phenology is predicted using a randomly generated temperature regime with mean 16 °C (Panel A) and mean 24 °C (Panel B). Panel C shows the effective values for different mean daily temperatures for each species, which are effectively species-specific linearized developmental reaction norms. Note the genetic x environment interactions in Panel C as temperatures warm and shown by the rank order change in species in Panel A compared with Panel B."}

### all the Rana's below refer to taxonomy from the paper, they are now genus Lithobates

# Rana sylvatica ----------------------------------------------------------

# Moore, 1939 Ecology
# https://www.jstor.org/stable/1930439?seq=1

rana_s_data <- tibble(temp = c(9, 21 ,26),
                      days = c(15,13,4))

rana_s_data <- tibble(temp = c(10,15.3,18.5,19.9, 23.7),
                      hours = c(305,128,87,79,52)) |>
  mutate(days = ceiling(hours/24))

rana_s_mod <- fit_model(temp = rana_s_data$temp,
                        days = rana_s_data$days,
                        species = "Rana_sylvatica",
                        development_type = "hatch")


# Rana pipiens -----------------------------------------------------------
# from Moore 1939

rana_pip_data <- tibble(temp = c(15.3,18.6,19.8, 26),
                        hours = c(168,116,99,57)) |>
  mutate(days = ceiling(hours/24))

rana_pip_mod <- fit_model(temp = rana_pip_data$temp,
                          days = rana_pip_data$days,
                          species = "Rana_pipiens",
                          development_type = "hatch")

# Lithobates clamitans ----------------------------------------------------------
# from Moore 1939

rana_c_data <- tibble(temp = c(15,19.8, 25.3,33.4),
                      hours = c(263,112,62,45)) |>
  mutate(days = ceiling(hours/24))

rana_c_mod <- fit_model(temp = rana_c_data$temp,
                        days = rana_c_data$days,
                        species = "Lithobates_clamitans",
                        development_type = "hatch")


# Rana palustris ----------------------------------------------------------
# from Moore 1939

rana_p_data <- tibble(temp = c(15.5,18.6, 19.9, 25.7),
                      hours = c(190,126,106,63)) |>
  mutate(days = ceiling(hours/24))

rana_p_mod <- fit_model(temp = rana_p_data$temp,
                        days = rana_p_data$days,
                        species = "Rana_palustris",
                        development_type = "hatch")

# Lithobates example --------------------------------------------------------------------

### Figure A Code
# run for temp 16 C
set.seed(123)
temperature_data_cold <- data.frame(temperatures = sort(rnorm(30, mean = 16, sd =2.5)),
                               dates = seq(ymd("2000-04-01"), ymd("2000-04-30"), by = "days"))

froggy_mods <- c(rana_s_mod$expression$expression,
                 rana_p_mod$expression$expression,
                 rana_c_mod$expression$expression,
                 rana_pip_mod$expression$expression)

froggy_hatch_cold <- map(froggy_mods,
                    predict_phenology,
                    data = temperature_data_cold,
                    dates = dates,
                    temperature = temperatures,
                    spawn.date = "2000-04-01") |>
  map_dbl("days_to_develop") |> 
  tibble()

colnames(froggy_hatch_cold)[1] <- "days_to_develop"
  
froggy_hatch_cold <- froggy_hatch_cold |> 
    mutate(species = c("Wood Frog", "Pickerel Frog", 
                       "Green Frog","Northern Leopard Frog" )) |> 
  arrange(desc(days_to_develop)) 

colnames(froggy_hatch_cold)[1] <- "days_to_develop"

froggy_hatch_cold <- froggy_hatch_cold |>
  mutate(start = ymd("2000-04-01"),
         stop = start + days_to_develop,
         index = seq(20.5,17.5, by = -1))



p2.1.a <- ggplot() +
  geom_point(data = temperature_data_cold, aes(x = dates, y = temperatures)) +
  geom_line(data = temperature_data_cold, aes(x = dates, y = temperatures)) +
  geom_rect(data = froggy_hatch_cold, aes(xmin = start, xmax = stop, ymax =index-.15, ymin = index-.5, fill = species)) +
  geom_label(data = froggy_hatch_cold, aes(x = start + (stop - start) / 1.45, y = (index -0.325), label = days_to_develop)) +
  labs(x = "Date", y = "Temperature (°C)") +
  scale_fill_manual(values = c("darkolivegreen4","deepskyblue4", "grey23",  "purple4"), name = "Species") +
  theme_classic() +
  theme(legend.position = c(0.75, 0.25))

# run for temp 24 C
set.seed(123)
temperature_data_warm <- data.frame(temperatures = sort(rnorm(30, mean = 24, sd =2.5)),
                                    dates = seq(ymd("2000-04-01"), ymd("2000-04-30"), by = "days"))

froggy_hatch_warm <- map(froggy_mods,
                         predict_phenology,
                         data = temperature_data_warm,
                         dates = dates,
                         temperature = temperatures,
                         spawn.date = "2000-04-01") |>
  map_dbl("days_to_develop") |> 
  tibble()

colnames(froggy_hatch_warm)[1] <- "days_to_develop"

froggy_hatch_warm <- froggy_hatch_warm |> 
  mutate(species = c("Wood Frog", "Pickerel Frog", 
                     "Green Frog","Northern Leopard Frog" )) |> 
  arrange(desc(days_to_develop)) 

colnames(froggy_hatch_warm)[1] <- "days_to_develop"

froggy_hatch_warm <- froggy_hatch_warm |>
  mutate(start = ymd("2000-04-01"),
         stop = start + days_to_develop,
         index = seq(28.5,25.5, by = -1))



p2.1.b <- ggplot() +
  geom_point(data = temperature_data_warm, aes(x = dates, y = temperatures)) +
  geom_line(data = temperature_data_warm, aes(x = dates, y = temperatures)) +
  geom_rect(data = froggy_hatch_warm, aes(xmin = start, xmax = stop, ymax =index-.15, ymin = index-.5, fill = species)) +
  geom_label(data = froggy_hatch_warm, aes(x = start + (stop - start) / 1.45, y = (index -0.325), label = days_to_develop)) +
  labs(x = "Date", y = "Temperature (°C)") +
  scale_fill_manual(values = c("darkolivegreen4","deepskyblue4", "grey23",  "purple4"), name = "Species") +
  theme_classic() +
  theme(legend.position = "none")

### Figure B code

temps <- c(6:25)
species = c("Wood Frog", "Pickerel Frog", 
                       "Green Frog","Northern Leopard Frog" )
ef_vals <- NULL

for( m in 1:length(froggy_mods)){
  mod = froggy_mods[m]
  frog = species[m]

for (x in temps) {
  ef <- eval(parse(text = mod))
  temp_df <- data.frame(temperature = x, 
                        effective_value = ef, 
                        frog_species = frog)
  ef_vals <- rbind(ef_vals, temp_df)
  
  }
}

data_2 <- tibble(temperature = c(0:25), effective_value = seq(0, 0.25, by = 0.01))

p2.2 <- ef_vals |> tibble() |> 
  ggplot(aes(x = temperature, y = effective_value, color = frog_species)) +
  geom_line() +
  geom_point() +
  geom_abline(intercept = 0, slope = .01, linetype = "dashed") +
  labs(x = "Daily Average Temperature (°C)", y = "Effective Value") +
  scale_color_manual(values = c("darkolivegreen4","deepskyblue4", "grey23",  "purple4"), name = "Species") +
  theme_classic() +
  theme(legend.position = "none")

(p2.1.a + p2.1.b) / p2.2 + plot_annotation(tag_levels = 'A')
```

## Local Adaptation

As was the case with the phylogenetic example, deveelopmental models may be parameterized for populations of the same species to better understand the effects of local adaptation. Here, we take data from a common garden experiment with Chinese cabbage beetles distributed across of a latitudinal cline of 3,440 kilometers [@tang2017]. The beetles were raised at six temperatures ranging from 16 to 28 C° and while development rates for females were very similar for populations from northern latitudes, populations from the south developed faster, consistent with the cogradient variation (local adaptation) where the genetic and environmental effects on phenotypes are additive [@conover2009, @sparks2022]. We further demonstrated this phenomena by fitting custom developmental models for each population (Longnan was removed because values were the same as Xiushui), showing rank order changes in developmental rates at colder temperatures, indicating cogradient phenotypes may only be expressed in a subset of temperatures (Figure 4).

```{r, fig.height= 5 , fig.width= 5, fig.align = 'center', fig.cap="Effective value models developed for five populations of cabbage beetle (females) along a latitudinal cline in China from Tang et al. 2017. Note the large difference in developmental rate between Xiushui County and the other, more notherly populations, which is indicative of cogradient variation."}
tang_temps <- c(16,19,22,24,26,28) 


hb <- c(24.834, 19.481, 14.172, 11.205, 9.865, 8.570)

sy <- c( 23.822, 19.129, 13.644, 10.897, 9.645, 8.306)

ta <- c( 21.887, 18.381, 12.984, 10.809, 9.382, 8.130)

xy <- c( 21.623, 18.337, 12.589, 10.633, 9.205, 8.085 )

xs <- c( 21.271, 16.666, 11.797, 9.929, 9.117, 6.942)

pop_list <- list(hb, sy, ta, xy, xs)

beetle_mods <- pop_list |> map(fit_model,
                temp = tang_temps,
                species = "cabbage beetle",
                development_type = "hatch") |> 
  map("expression") |> 
  map("expression") |> 
  unlist()

temps <- c(12:30)
pops = c("Haerbin City", 
         "Shenyang City", 
         "Taian City",
         "Xinyang County",
         "Xiushui County")

ef_vals_pops <- NULL

for( m in 1:length(beetle_mods)){
  mod = beetle_mods[m]
  pop = pops[m]

for (x in temps) {
  ef <- eval(parse(text = mod))
  temp_df <- data.frame(temperature = x, 
                        effective_value = ef, 
                        beetle_pops = pop)
  ef_vals_pops <- rbind(ef_vals_pops, temp_df)
  
  }
}

ef_vals_pops |> tibble() |> 
  ggplot(aes(x = temperature, y = effective_value, color = beetle_pops)) +
  geom_line() +
  geom_point() +
  #geom_abline(intercept = 0, slope = .01, linetype = "dashed") +
  labs(x = "Daily Average Temperature (°C)", y = "Effective Value") +
  scale_color_brewer(palette = "Dark2", name = "Beetle Populations") +
  theme_classic() +
  theme(legend.position = c(0.25, 0.75))
```

# Discussion

P1: Summary of above

P2: Caveats

-   namely that some taxa like insects and frogs are much more likely to bail on development when environmental cues suggest they need to
-   more studies need to include more than 2 temperatures @qualls1998 @kozák2009

P3: Other considerations?

-   easy to parameterize custom models for quick developing species
-   examples where other stages could be modeled assuming constant feeding [@lillehammer1986]

P4: ???

### Conclusion

Isn't this a great tool with so many applications!?

# Bibliography
